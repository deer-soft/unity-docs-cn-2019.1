<!DOCTYPE html><html class="no-js">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5V25JL6');
    </script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<meta property="og:title" content="编写多个着色器程序变体 - Unity Manual">
<title>编写多个着色器程序变体 - Unity Manual</title>
<meta name="description" content="通常方便的做法是保持大部分着色器代码固定，但也允许生成稍微不同的着色器&amp;#8220;变体&amp;#8221;。这种变体通常称为&amp;#8220;大型着色器&amp;#8221;或&amp;#8220;超级着色器&amp;#8221;，实现的方式是针对每种情况使用不同的预处理器指令多次编译着色器代码。">
<meta property="og:description" content="通常方便的做法是保持大部分着色器代码固定，但也允许生成稍微不同的着色器&amp;#8220;变体&amp;#8221;。这种变体通常称为&amp;#8220;大型着色器&amp;#8221;或&amp;#8220;超级着色器&amp;#8221;，实现的方式是针对每种情况使用不同的预处理器指令多次编译着色器代码。">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="../StaticFiles/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png">
<script>
      var docs_type = 'Manual';
      var lang = 'zh_CN';
      var page = 'SL-MultipleProgramVariants';
      if(!page) page = 'index';
      var version = '2019.1';
      var docs_versions = [{version: '2019.3',version_string: '2019.3'},{version: '2019.2',version_string: '2019.2'},{version: '2019.1',version_string: '2019.1'},{version: '2018.4',version_string: '2018.4'},{version: '2018.3',version_string: '2018.3'},{version: '2018.2',version_string: '2018.2'},{version: '2018.1',version_string: '2018.1'},{version: '2017.4',version_string: '2017.4'},{version: '2017.3',version_string: '2017.3'},{version: '2017.2',version_string: '2017.2'},{version: '2017.1',version_string: '2017.1'},{version: '5.6',version_string: '560'},];</script><script type="text/javascript" src="../StaticFiles/js/jquery.js"></script><script type="text/javascript" src="../StaticFiles/js/core.js"></script><script type="text/javascript" src="../StaticFiles/js/jquery.sidebar.min.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src=""></script><script type="text/javascript" src="../StaticFiles/js/custom.js"></script><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/custom.css">
</head>
<body>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5V25JL6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="https://docs.unity3d.com"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul class="menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">Manual</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">Scripting API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity3d.com/">
                unity3d.com
              </a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2019.1</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;"><ul>
<li><a class="docs_version_url_2019.3" href="/zh_CN/2019.3/Manual/SL-MultipleProgramVariants.html">2019.3</a></li>
<li><a class="docs_version_url_2019.2" href="/zh_CN/2019.2/Manual/SL-MultipleProgramVariants.html">2019.2</a></li>
<li><a class="docs_version_url_2019.1" href="/zh_CN/2019.1/Manual/SL-MultipleProgramVariants.html">2019.1</a></li>
<li><a class="docs_version_url_2018.4" href="/zh_CN/2018.4/Manual/SL-MultipleProgramVariants.html">2018.4</a></li>
<li><a class="docs_version_url_2018.3" href="/zh_CN/2018.3/Manual/SL-MultipleProgramVariants.html">2018.3</a></li>
<li><a class="docs_version_url_2018.2" href="/zh_CN/2018.2/Manual/SL-MultipleProgramVariants.html">2018.2</a></li>
<li><a class="docs_version_url_2018.1" href="/zh_CN/2018.1/Manual/SL-MultipleProgramVariants.html">2018.1</a></li>
<li><a class="docs_version_url_2017.4" href="/zh_CN/2017.4/Manual/SL-MultipleProgramVariants.html">2017.4</a></li>
<li><a class="docs_version_url_2017.3" href="/zh_CN/2017.3/Manual/SL-MultipleProgramVariants.html">2017.3</a></li>
<li><a class="docs_version_url_2017.2" href="/zh_CN/2017.2/Manual/SL-MultipleProgramVariants.html">2017.2</a></li>
<li><a class="docs_version_url_2017.1" href="/zh_CN/2017.1/Manual/SL-MultipleProgramVariants.html">2017.1</a></li>
<li><a class="docs_version_url_560" href="/zh_CN/560/Manual/SL-MultipleProgramVariants.html">5.6</a></li>
</ul></div>
</div>
<ul class="nav-menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">Manual</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">Scripting API</a></li>
</ul>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">Language:
        <span class="b">中文</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a data-lang="en" href="/2019.1/Documentation/Manual/SL-MultipleProgramVariants.html">English</a></li>
<li><a data-lang="ja" href="/ja/2019.1/Manual/SL-MultipleProgramVariants.html">日本語</a></li>
<li><a data-lang="es" href="/es/2019.1/Manual/SL-MultipleProgramVariants.html">Español</a></li>
<li><a data-lang="kr" href="/kr/2019.1/Manual/SL-MultipleProgramVariants.html">한국어</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar hidden"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc">
<h2>Manual</h2>
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2019.1</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;"><ul>
<li><a class="docs_version_url_2019.3" href="/zh_CN/2019.3/Manual/SL-MultipleProgramVariants.html">2019.3</a></li>
<li><a class="docs_version_url_2019.2" href="/zh_CN/2019.2/Manual/SL-MultipleProgramVariants.html">2019.2</a></li>
<li><a class="docs_version_url_2019.1" href="/zh_CN/2019.1/Manual/SL-MultipleProgramVariants.html">2019.1</a></li>
<li><a class="docs_version_url_2018.4" href="/zh_CN/2018.4/Manual/SL-MultipleProgramVariants.html">2018.4</a></li>
<li><a class="docs_version_url_2018.3" href="/zh_CN/2018.3/Manual/SL-MultipleProgramVariants.html">2018.3</a></li>
<li><a class="docs_version_url_2018.2" href="/zh_CN/2018.2/Manual/SL-MultipleProgramVariants.html">2018.2</a></li>
<li><a class="docs_version_url_2018.1" href="/zh_CN/2018.1/Manual/SL-MultipleProgramVariants.html">2018.1</a></li>
<li><a class="docs_version_url_2017.4" href="/zh_CN/2017.4/Manual/SL-MultipleProgramVariants.html">2017.4</a></li>
<li><a class="docs_version_url_2017.3" href="/zh_CN/2017.3/Manual/SL-MultipleProgramVariants.html">2017.3</a></li>
<li><a class="docs_version_url_2017.2" href="/zh_CN/2017.2/Manual/SL-MultipleProgramVariants.html">2017.2</a></li>
<li><a class="docs_version_url_2017.1" href="/zh_CN/2017.1/Manual/SL-MultipleProgramVariants.html">2017.1</a></li>
<li><a class="docs_version_url_560" href="/zh_CN/560/Manual/SL-MultipleProgramVariants.html">5.6</a></li>
</ul></div>
</div>
<div class="clear"></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap opened-sidebar"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual (2019.1)</a></li>
<li><a href="Graphics.html">图形</a></li>
<li><a href="GraphicsReference.html">图形参考</a></li>
<li><a href="SL-Reference.html">着色器参考</a></li>
<li><a href="SL-ShaderPrograms.html">编写顶点和片元着色器</a></li>
<li>编写多个着色器程序变体</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="SL-UnityShaderVariables.html"></a></span><div class="tip">内置着色器变量</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="SL-GLSLShaderPrograms.html"></a></span><div class="tip">GLSL 着色器程序</div>
</div>
</div></div>
<h1>编写多个着色器程序变体</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>通常方便的做法是保持大部分着色器代码固定，但也允许生成稍微不同的着色器“变体”。这种变体通常称为“大型着色器”或“超级着色器”，实现的方式是针对每种情况使用不同的预处理器指令多次编译着色器代码。</p>

<p>To achieve this in Unity, you can add a <code>#pragma multi_compile</code> or <code>#pragma shader_feature</code> directive to a <a href="SL-ShaderPrograms.html">shader snippet</a>. This also works in <a href="SL-SurfaceShaders.html">surface shaders</a>.</p>

<p>At run time, Unity picks up the appropriate shader variant from the Material keywords (<a href="../ScriptReference/Material.EnableKeyword.html">Material.EnableKeyword</a> and <a href="../ScriptReference/Material.DisableKeyword.html">Shader.DisableKeyword</a>) or global shader keywords (<a href="../ScriptReference/Shader.EnableKeyword.html">Shader.EnableKeyword</a> and <a href="../ScriptReference/Shader.DisableKeyword.html">Shader.DisableKeyword</a>).</p>

<h2>multi_compile 的工作方式</h2>

<p>Example directive:</p>

<pre><code># pragma multi_compile FANCY_STUFF_OFF FANCY_STUFF_ON
</code></pre>

<p>This example directive produces two shader variants: one with <code>FANCY_STUFF_OFF</code> defined, and another with <code>FANCY_STUFF_ON</code>. At run time, Unity activates one of them based on the Material or global shader keywords. If neither of these two keywords are enabled, then Unity uses the first one (in this example, <code>FANCY_STUFF_OFF</code>).</p>

<p>You can add more than two keywords on a multi_compile line. For example:</p>

<pre><code># pragma multi_compile SIMPLE_SHADING BETTER_SHADING GOOD_SHADING BEST_SHADING
</code></pre>

<p>This example directive produces four shader variants: <code>SIMPLE_SHADING</code>, <code>BETTER_SHADING</code>, <code>GOOD_SHADING</code>, and <code>BEST_SHADING</code>.</p>

<p>To produce a shader variant with no preprocessor macro defined, add a name that is just underscores (<code>__</code>). This is a common technique to avoid using up two keywords, because there is a limit on how many you can use in a project (see later section on <a href="#KeywordLimits">Keyword limits</a>). For example:</p>

<pre><code># pragma multi_compile __ FOO_ON
</code></pre>

<p>This directive produces two shader variants: one with nothing defined (<code>__</code>), and one with <code>FOO_ON</code> defined.</p>

<h2>shader_feature 与 multi_compile 之间的区别</h2>

<p><code>shader_feature</code> is very similar to <code>multi_compile</code>. The only difference is that Unity does not include unused variants of <code>shader_feature</code> shaders in the final build. For this reason, you should use <code>shader_feature</code> for keywords that are set from the Materials, while <code>multi_compile</code> is better for keywords that are set from code globally.</p>

<p>Additionally, there is a shorthand notation with just one keyword:</p>

<pre><code># pragma shader_feature FANCY_STUFF
</code></pre>

<p>Which is just a shortcut for <code>#pragma shader_feature _ FANCY_STUFF</code>. It expands into two shader variants (first one without the define; second one with it).</p>

<h2>合并多个 multi_compile 行</h2>

<p>If you provide <code>multi_compile</code> lines, Unity compiles the resulting shader for all possible combinations of the lines. For example:</p>

<pre><code># pragma multi_compile A B C
# pragma multi_compile D E
</code></pre>

<p>This produces three variants for the first line, and two for the second line. In total, it produces total six shader variants (A+D, B+D, C+D, A+E, B+E, C+E).</p>

<p>Think of each <code>multi_compile</code> line as controlling a single shader “feature”. Keep in mind that the total number of shader variants grows really fast this way. For example, ten <code>multi_compile</code> features, each with two options, produces 1024 shader variants in total.</p>

<p><a name="KeywordLimits"> </a></p>

<h2>Keyword limits</h2>

<p>When using Shader variants, there is a limit of 256 keywords in Unity, and Unity uses around 60 of them internally (therefore lowering the available limit). The keywords are enabled globally across a Unity project, so be careful not to exceed the limit when you define multiple keywords in several different Shaders.</p>

<h3>Local keywords</h3>

<p>The main disadvantage of <strong>shader_feature</strong> and <strong>multi_compile</strong> is that all keywords defined in them contribute towards Unity’s global keyword count limit (256 global keywords, plus 64 local keywords). To avoid this issue, you can use different shader variant directives: <strong>shader_feature_local</strong> and <strong>multi_compile_local</strong>. </p>

<ul>
<li>
<strong>shader_feature_local:</strong> similar to <strong>shader_feature</strong>, but enumerated keywords are local.</li>
<li>
<strong>multi_compile_local:</strong> similar to <strong>multi_compile</strong>, but enumerated keywords are local.</li>
</ul>

<p>Local directives keep defined keywords under them specific to that shader, rather than applying them to the whole Project. For this reason, you should use local keywords instead of global keywords, unless you are planning to enable those particular keywords through the global API.</p>

<p>You might see a change in performance when you start using local keywords, but the difference depends on how your Project is set up. The total number of local and global keywords per shader affects performance: in an ideal set-up, use more local keywords and fewer global keywords, to reduce the total keyword count per shader.</p>

<p>If there are global and local keywords with the same name, Unity prioritises the local keyword.</p>

<h4>Limitations</h4>

<ul>
<li><p>You cannot use local keywords with APIs that make global keyword changes (such as Shader.EnableKeyword or CommandBuffer.EnableShaderKeyword).</p></li>
<li><p>There is a maximum of 64 unique local keywords per shader.</p></li>
<li><p>If a Material has a local keyword enabled, and its shader changes to one that is no longer declared, Unity creates a new global keyword.</p></li>
</ul>

<h4>示例</h4>

<pre><code>#pragma multi_compile_local __ FOO_ON
</code></pre>

<p>This directive produces two shader variants: one with nothing defined (<code>__</code>), and one with <code>FOO_ON</code> defined as a local keyword.</p>

<p>The process for enabling local keywords is the same as enabling global keywords: </p>

<pre><code>public Material mat;
Private void Start()
{
    mat.EnableKeyword("FOO_ON");
}
</code></pre>

<h2>内置 multi_compile 快捷方式</h2>

<p>There are several “shortcut” notations for compiling multiple shader variants. These are mostly to deal with different light, shadow and lightmap types in Unity. See documentation on the <a href="SL-RenderPipeline.html">rendering pipeline</a> for details.</p>

<ul>
<li>
<code>multi_compile_fwdbase</code> compiles all variants needed by <a href="../ScriptReference/Rendering.PassType.ForwardBase.html">PassType.ForwardBase</a>. The variants deal with different lightmap types, and the main Directional Light’s shadows being enabled or disabled.</li>
<li>
<code>multi_compile_fwdadd</code> compiles variants for <a href="../ScriptReference/Rendering.PassType.ForwardAdd.html">PassType.ForwardAdd</a>. This compiles variants to handle Directional, Spot or Point Light types and their variants with cookie Textures.</li>
<li>
<code>multi_compile_fwdadd_fullshadows</code> - same as <code>multi_compile_fwdadd</code>, but also includes ability for the lights to have real-time shadows.</li>
<li>
<code>multi_compile_fog</code> 扩展为多个变体以处理不同的雾效类型 (off/linear/exp/exp2)。</li>
</ul>

<p>Most of the built-in shortcuts produce many shader variants. if you know the project doesn’t need them, you can use <code>#pragma skip_variants</code> to skip compiling some of them. For example:</p>

<pre><code>#pragma multi_compile_fwdadd
#pragma skip_variants POINT POINT_COOKIE
</code></pre>

<p>This directive skips all variants containing <code>POINT</code> or <code>POINT_COOKIE</code>.</p>

<h2>Shader hardware variants</h2>

<p>Shader hardward variants allow you to provide a specially optimised set of variants for different levels of hardware capability. You can create simplified shaders that can run efficiently on both high-end and low-end hardware within a single target platform (such as OpenGL ES). </p>

<p>To enable the generation of shader hardware variants, add <code>#pragma hardware_tier_variants renderer</code>, where <code>renderer</code> is one of the available renderering platforms for <a href="SL-ShaderPrograms.html">shader program pragmas</a>. With this <code>#pragma</code>, Unity generates three shader variants for each shader, regardless of any other keywords. Each variant has one of the following defined:</p>

<pre><code>UNITY_HARDWARE_TIER1
UNITY_HARDWARE_TIER2
UNITY_HARDWARE_TIER3
</code></pre>

<p>Use these to write conditional fallbacks or extra features for lower or higher-end hardware. In the Unity Editor, you can test any of the tiers in the Graphics Emulation menu, which allows you to change between each of the tiers.</p>

<p>To help keep the impact of these variants as small as possible, Unity only ever loads one set of shaders in the player. Shaders that are identical (for example, if you only write a specialised version for TIER1 and all others are the same) do not take up any extra space on disk.</p>

<p>At load time, Unity examines the GPU that it is using and auto-detects a tier value. It defaults to the highest tier if it can’t auto-detect the GPU. You can set <code>Shader.globalShaderHardwareTier</code> to override this tier value, but you must do this before Unity loads any shaders you want to vary. A good place to set this is in a pre-load Scene before you load your main Scene.</p>

<p>These shader hardware tiers are not related to the <strong>Quality</strong> settings of the player. They are detected from the relative capability of the GPU that the player runs on.</p>

<h2>Platform shader settings</h2>

<p>Apart from tweaking your shader code for different hardware tiers, you might want to tweak Unity’s internal #defines (for example, you might want to force cascaded shadowmaps on mobiles). For details on how to do this, see documentation on <a href="../ScriptReference/Rendering.PlatformShaderSettings.html">UnityEditor.Rendering.PlatformShaderSettings</a>, which provides a list of currently supported features for overriding per-tier.</p>

<p>Use <a href="../ScriptReference/Rendering.EditorGraphicsSettings.SetShaderSettingsForPlatform.html">UnityEditor.Rendering.EditorGraphicsSettings.SetShaderSettingsForPlatform</a> to tweak Platform Shader Settings per-platform per-tier.</p>

<p>If <code>PlatformShaderSettings</code> set to different tiers are not identical, then Unity generates tier variants for the shader, even if <code>#pragma hardware_tier_variants</code> is missing.</p>

<h3>另请参阅</h3>

<ul>
<li><a href="OptimizingShaderLoadTime.html">优化着色器加载时间</a></li>
</ul>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="SL-UnityShaderVariables.html"></a></span><div class="tip">内置着色器变量</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="SL-GLSLShaderPrograms.html"></a></span><div class="tip">GLSL 着色器程序</div>
</div>
</div>
</div>
<div class="footer-wrapper">
<div class="footer clear">
<div class="copy">Copyright © 2019 Unity Technologies. Publication 2019.1</div>
<div class="menu">
<a href="https://unity3d.com/learn">Tutorials</a><a href="https://answers.unity3d.com">Community Answers</a><a href="https://support.unity3d.com/hc/en-us">Knowledge Base</a><a href="https://forum.unity3d.com">Forums</a><a href="https://unity3d.com/asset-store">Asset Store</a>
</div>
</div>
<div></div>
</div>
</div></div></div>
</div>
</body>
</html>
