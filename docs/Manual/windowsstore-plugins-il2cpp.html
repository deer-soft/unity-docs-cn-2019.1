<!DOCTYPE html><html class="no-js">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5V25JL6');
    </script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<meta property="og:title" content="通用 Windows 平台：IL2CPP 脚本后端上的插件 - Unity Manual">
<title>通用 Windows 平台：IL2CPP 脚本后端上的插件 - Unity Manual</title>
<meta property="og:image" content="https://docs.unity3d.com/zh_CN/2019.1/uploads/Main/NativeFunctions.png">
<meta name="description" content="The plugin model for Universal Windows Platform is similar to other Unity platforms (such as Windows standalone).">
<meta property="og:description" content="The plugin model for Universal Windows Platform is similar to other Unity platforms (such as Windows standalone).">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="../StaticFiles/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png">
<script>
      var docs_type = 'Manual';
      var lang = 'zh_CN';
      var page = 'windowsstore-plugins-il2cpp';
      if(!page) page = 'index';
      var version = '2019.1';
      var docs_versions = [{version: '2019.3',version_string: '2019.3'},{version: '2019.2',version_string: '2019.2'},{version: '2019.1',version_string: '2019.1'},{version: '2018.4',version_string: '2018.4'},{version: '2018.3',version_string: '2018.3'},{version: '2018.2',version_string: '2018.2'},{version: '2018.1',version_string: '2018.1'},{version: '2017.4',version_string: '2017.4'},{version: '2017.3',version_string: '2017.3'},{version: '2017.2',version_string: '2017.2'},{version: '2017.1',version_string: '2017.1'},{version: '5.6',version_string: '560'},];</script><script type="text/javascript" src="../StaticFiles/js/jquery.js"></script><script type="text/javascript" src="../StaticFiles/js/core.js"></script><script type="text/javascript" src="../StaticFiles/js/jquery.sidebar.min.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src=""></script><script type="text/javascript" src="../StaticFiles/js/custom.js"></script><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css">
<link rel="stylesheet" type="text/css" href="../StaticFiles/css/custom.css">
</head>
<body>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5V25JL6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div id="nav-open" for="nav-input"><span></span></div>
<div class="logo"><a href="https://docs.unity3d.com"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul class="menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">Manual</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">Scripting API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="https://unity3d.com/">
                unity3d.com
              </a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2019.1</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;"><ul>
<li><a class="docs_version_url_2019.3" href="/zh_CN/2019.3/Manual/windowsstore-plugins-il2cpp.html">2019.3</a></li>
<li><a class="docs_version_url_2019.2" href="/zh_CN/2019.2/Manual/windowsstore-plugins-il2cpp.html">2019.2</a></li>
<li><a class="docs_version_url_2019.1" href="/zh_CN/2019.1/Manual/windowsstore-plugins-il2cpp.html">2019.1</a></li>
<li><a class="docs_version_url_2018.4" href="/zh_CN/2018.4/Manual/windowsstore-plugins-il2cpp.html">2018.4</a></li>
<li><a class="docs_version_url_2018.3" href="/zh_CN/2018.3/Manual/windowsstore-plugins-il2cpp.html">2018.3</a></li>
<li><a class="docs_version_url_2018.2" href="/zh_CN/2018.2/Manual/windowsstore-plugins-il2cpp.html">2018.2</a></li>
<li><a class="docs_version_url_2018.1" href="/zh_CN/2018.1/Manual/windowsstore-plugins-il2cpp.html">2018.1</a></li>
<li><a class="docs_version_url_2017.4" href="/zh_CN/2017.4/Manual/windowsstore-plugins-il2cpp.html">2017.4</a></li>
<li><a class="docs_version_url_2017.3" href="/zh_CN/2017.3/Manual/windowsstore-plugins-il2cpp.html">2017.3</a></li>
<li><a class="docs_version_url_2017.2" href="/zh_CN/2017.2/Manual/windowsstore-plugins-il2cpp.html">2017.2</a></li>
<li><a class="docs_version_url_2017.1" href="/zh_CN/2017.1/Manual/windowsstore-plugins-il2cpp.html">2017.1</a></li>
<li><a class="docs_version_url_560" href="/zh_CN/560/Manual/windowsstore-plugins-il2cpp.html">5.6</a></li>
</ul></div>
</div>
<ul class="nav-menu-items">
<li class="menu-item"><a href="../Manual/index.html" class="selected">Manual</a></li>
<li class="menu-item"><a href="../ScriptReference/index.html" class="">Scripting API</a></li>
</ul>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">Language:
        <span class="b">中文</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a data-lang="en" href="/2019.1/Documentation/Manual/windowsstore-plugins-il2cpp.html">English</a></li>
<li><a data-lang="ja" href="/ja/2019.1/Manual/windowsstore-plugins-il2cpp.html">日本語</a></li>
<li><a data-lang="es" href="/es/2019.1/Manual/windowsstore-plugins-il2cpp.html">Español</a></li>
<li><a data-lang="kr" href="/kr/2019.1/Manual/windowsstore-plugins-il2cpp.html">한국어</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar hidden"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc">
<h2>Manual</h2>
<div class="version-switcher">
<div class="current toggle" data-target=".version-list"><div class="version-number">
<div class="d-inline-block">
          Version:
          <b>2019.1</b>
</div>
<div class="d-inline-block arrow"></div>
</div></div>
<div class="version-list" style="display:none;"><ul>
<li><a class="docs_version_url_2019.3" href="/zh_CN/2019.3/Manual/windowsstore-plugins-il2cpp.html">2019.3</a></li>
<li><a class="docs_version_url_2019.2" href="/zh_CN/2019.2/Manual/windowsstore-plugins-il2cpp.html">2019.2</a></li>
<li><a class="docs_version_url_2019.1" href="/zh_CN/2019.1/Manual/windowsstore-plugins-il2cpp.html">2019.1</a></li>
<li><a class="docs_version_url_2018.4" href="/zh_CN/2018.4/Manual/windowsstore-plugins-il2cpp.html">2018.4</a></li>
<li><a class="docs_version_url_2018.3" href="/zh_CN/2018.3/Manual/windowsstore-plugins-il2cpp.html">2018.3</a></li>
<li><a class="docs_version_url_2018.2" href="/zh_CN/2018.2/Manual/windowsstore-plugins-il2cpp.html">2018.2</a></li>
<li><a class="docs_version_url_2018.1" href="/zh_CN/2018.1/Manual/windowsstore-plugins-il2cpp.html">2018.1</a></li>
<li><a class="docs_version_url_2017.4" href="/zh_CN/2017.4/Manual/windowsstore-plugins-il2cpp.html">2017.4</a></li>
<li><a class="docs_version_url_2017.3" href="/zh_CN/2017.3/Manual/windowsstore-plugins-il2cpp.html">2017.3</a></li>
<li><a class="docs_version_url_2017.2" href="/zh_CN/2017.2/Manual/windowsstore-plugins-il2cpp.html">2017.2</a></li>
<li><a class="docs_version_url_2017.1" href="/zh_CN/2017.1/Manual/windowsstore-plugins-il2cpp.html">2017.1</a></li>
<li><a class="docs_version_url_560" href="/zh_CN/560/Manual/windowsstore-plugins-il2cpp.html">5.6</a></li>
</ul></div>
</div>
<div class="clear"></div>
</div></div></div></div></div>
<div id="content-wrap" class="content-wrap opened-sidebar"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual (2019.1)</a></li>
<li><a href="PlatformSpecific.html">特定于平台的信息</a></li>
<li><a href="Windows.html">Windows</a></li>
<li><a href="WindowsStore.html">通用 Windows 平台</a></li>
<li><a href="windowsstore-il2cpp.html">通用 Windows 平台：IL2CPP 脚本后端</a></li>
<li>通用 Windows 平台：IL2CPP 脚本后端上的插件</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="windowsstore-generatedproject-il2cpp.html"></a></span><div class="tip">通用 Windows 平台：使用 IL2CPP 脚本后端生成的项目</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="windowsstore-debugging-il2cpp.html"></a></span><div class="tip">通用 Windows 平台：IL2CPP 脚本后端上的调试</div>
</div>
</div></div>
<h1>通用 Windows 平台：IL2CPP 脚本后端上的插件</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>The plugin model for Universal Windows Platform is similar to other Unity platforms (such as Windows standalone).</p>

<h2>托管插件</h2>

<p>By default, IL2CPP targets .NET 2.0 API compatiblity level. That means it does not support managed plugins targeting .NET 4.5 or consuming any of Windows Runtime APIs. All managed plugins must be targeting .NET 4.5 or equivalent API when using this compatiblity level. You can switch to .NET 4.6 API compatibilty level in <strong>Player</strong> settings if you wish to lift these restrictions.</p>

<p><strong>Note</strong> The .Net 3.5 scripting runtime is deprecated, but it will be available for Unity 2018.3 and 2018.4 LTS. Please migrate or start new Projects with the .NET 4.x runtime.</p>

<p>IL2CPP scripting backend exposes the exact same .NET API surface as Unity editor or standalone player, so it’s possible to use the same plugins without the need to compile separate versions targetting different .NET API for Universal Windows Platform.</p>

<h2>原生插件</h2>

<p>IL2CPP 脚本后端支持通过 P/Invoke 机制使用原生插件。也就是说，可通过指定原生函数原型再调用该函数来直接从 C# 代码调用原生插件。例如：</p>

<pre><code>[DllImport("MyPlugin.dll")]
private static extern int CountLettersInString([MarshalAs(UnmanagedType.LPWSTR)]string str);

private void Start()
{
    Debug.Log(CountLettersInString("Hello, native plugin!"));
}
</code></pre>

<p>此类函数在 MyPlugin.dll 内的实现如下所示：</p>

<pre><code>extern "C" __declspec(dllexport)
int __stdcall CountLettersInString(wchar_t* str)
{
    int length = 0;
    while (*str++ != nullptr)
        length++;
    return length;
}
</code></pre>

<p>P/Invoke 编组规则与官方 .NET 编组规则一致，但少数不受支持的类型除外：</p>

<ul>
<li>AnsiBStr</li>
<li>Currency</li>
<li>SAFEARRAY</li>
<li>IDispatch</li>
<li>TBStr</li>
<li>VBByRefStr</li>
</ul>

<p>在 x86 上，P/Invoke 函数的默认调用约定为 <code>__stdcall</code>。</p>

<p>可通过两种方式编写原生插件：预编译的 DLL 或 C++ 源代码。</p>

<h3>预编译的原生插件</h3>

<p>对预编译的原生插件进行 P/Invoke 调用的工作原理是在运行时加载 DLL，找到函数入口点，然后调用它。必须针对目标 CPU 架构的适当 Windows SDK 编译这些 DLL。添加到 Unity 项目时，还必须在 Plugin Inspector 中配置这些 DLL。</p>

<h3>C++ 源代码原生插件</h3>

<p>可以将 C++ (.cpp) 代码文件直接添加到 Unity 项目中作为 Plugin Inspector 中的插件。如果配置为与通用 Windows 平台和 IL2CPP 脚本后端兼容，这些 C++ 文件将与从托管程序集生成的 C++ 代码一起编译：</p>

<figure>
<img src="../uploads/Main/NativeFunctions.png" alt="">
</figure>

<p>由于函数与生成的 C++ 代码链接在一起，所以没有单独的 DLL 可进行 P/Invoke 调用。因此，可以使用“__Internal”关键字代替 DLL 名称，从而使 C++ 链接器负责解析函数，而不是在运行时加载函数：</p>

<pre><code>[DllImport("__Internal")]
private static extern int CountLettersInString([MarshalAs(UnmanagedType.LPWSTR)]string str);
</code></pre>

<p>由于调用由链接器解析，因此在托管端的函数声明中发生错误将产生链接器错误，而不是运行时的错误。这也意味着，在运行时不需要进行动态加载，而直接调用函数。这种方式显著降低了 P/Invoke 调用的开销。</p>

<h3>P/Invoke 限制</h3>

<p>在通用 Windows 平台上，无法在使用 IL2CPP 脚本后端时指定 dll 名称（如“kernelbase.dll”）来对特定系统库进行 P/Invoke 调用。尝试对项目外部的任何 DLL 进行 P/Invoke 调用将导致运行时出现 DllNotFoundException。</p>

<p>但是，仍然可以通过指定“**Internal”关键字而不是 DLL 名称来对这些系统函数进行 P/Invoke 调用，这会使链接器在构建时解析函数。</p>

<h2>另请参阅</h2>

<p><a href="PluginInspector.html" title="Plugin Inspector">Plugin Inspector</a></p>

<hr>

<ul>
<li>
<span class="page-edit">• 2018–08–03 Page amended with no <a href="DocumentationEditorialReview.html">editorial review</a>
</span><br>
</li>
<li><span class="page-history">.NET 3.5 scripting runtime deprecated in 2018.3</span></li>
</ul>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="windowsstore-generatedproject-il2cpp.html"></a></span><div class="tip">通用 Windows 平台：使用 IL2CPP 脚本后端生成的项目</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="windowsstore-debugging-il2cpp.html"></a></span><div class="tip">通用 Windows 平台：IL2CPP 脚本后端上的调试</div>
</div>
</div>
</div>
<div class="footer-wrapper">
<div class="footer clear">
<div class="copy">Copyright © 2019 Unity Technologies. Publication 2019.1</div>
<div class="menu">
<a href="https://unity3d.com/learn">Tutorials</a><a href="https://answers.unity3d.com">Community Answers</a><a href="https://support.unity3d.com/hc/en-us">Knowledge Base</a><a href="https://forum.unity3d.com">Forums</a><a href="https://unity3d.com/asset-store">Asset Store</a>
</div>
</div>
<div></div>
</div>
</div></div></div>
</div>
</body>
</html>
